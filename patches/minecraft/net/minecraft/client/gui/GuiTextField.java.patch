--- before/net/minecraft/client/gui/GuiTextField.java
+++ after/net/minecraft/client/gui/GuiTextField.java
@@ -1,7 +1,7 @@
 package net.minecraft.client.gui;
 
+import com.cleanroommc.client.IMEWrapper;
 import com.google.common.base.Predicate;
-import com.google.common.base.Predicates;
 import net.minecraft.client.Minecraft;
 import net.minecraft.client.renderer.BufferBuilder;
 import net.minecraft.client.renderer.GlStateManager;
@@ -35,7 +35,7 @@
     private int field_146221_u = 7368816;
     private boolean field_146220_v = true;
     private GuiPageButtonList.GuiResponder field_175210_x;
-    private Predicate<String> field_175209_y = Predicates.<String>alwaysTrue();
+    private java.util.function.Predicate<String> field_175209_y = s -> true;
 
     public GuiTextField(int p_i45542_1_, FontRenderer p_i45542_2_, int p_i45542_3_, int p_i45542_4_, int p_i45542_5_, int p_i45542_6_)
     {
@@ -59,7 +59,7 @@
 
     public void func_146180_a(String p_146180_1_)
     {
-        if (this.field_175209_y.apply(p_146180_1_))
+        if (this.field_175209_y.test(p_146180_1_))
         {
             if (p_146180_1_.length() > this.field_146217_k)
             {
@@ -69,7 +69,7 @@
             {
                 this.field_146216_j = p_146180_1_;
             }
-
+            IMEWrapper.setText(this.field_146216_j);
             this.func_146202_e();
         }
     }
@@ -81,22 +81,22 @@
 
     public String func_146207_c()
     {
-        int i = this.field_146224_r < this.field_146223_s ? this.field_146224_r : this.field_146223_s;
-        int j = this.field_146224_r < this.field_146223_s ? this.field_146223_s : this.field_146224_r;
+        int i = Math.min(this.field_146224_r, this.field_146223_s);
+        int j = Math.max(this.field_146224_r, this.field_146223_s);
         return this.field_146216_j.substring(i, j);
     }
 
     public void func_175205_a(Predicate<String> p_175205_1_)
     {
-        this.field_175209_y = p_175205_1_;
+        this.field_175209_y = p_175205_1_::test;
     }
 
     public void func_146191_b(String p_146191_1_)
     {
         String s = "";
         String s1 = ChatAllowedCharacters.func_71565_a(p_146191_1_);
-        int i = this.field_146224_r < this.field_146223_s ? this.field_146224_r : this.field_146223_s;
-        int j = this.field_146224_r < this.field_146223_s ? this.field_146223_s : this.field_146224_r;
+        int i = Math.min(this.field_146224_r, this.field_146223_s);
+        int j = Math.max(this.field_146224_r, this.field_146223_s);
         int k = this.field_146217_k - this.field_146216_j.length() - (i - j);
 
         if (!this.field_146216_j.isEmpty())
@@ -122,9 +122,10 @@
             s = s + this.field_146216_j.substring(j);
         }
 
-        if (this.field_175209_y.apply(s))
+        if (this.field_175209_y.test(s))
         {
             this.field_146216_j = s;
+            IMEWrapper.setText(s);
             this.func_146182_d(i - this.field_146223_s + l);
             this.func_190516_a(this.field_175208_g, this.field_146216_j);
         }
@@ -178,10 +179,10 @@
                     s = s + this.field_146216_j.substring(j);
                 }
 
-                if (this.field_175209_y.apply(s))
+                if (this.field_175209_y.test(s))
                 {
                     this.field_146216_j = s;
-
+                    IMEWrapper.setText(s);
                     if (flag)
                     {
                         this.func_146182_d(p_146175_1_);
@@ -261,6 +262,7 @@
         int i = this.field_146216_j.length();
         this.field_146224_r = MathHelper.func_76125_a(this.field_146224_r, 0, i);
         this.func_146199_i(this.field_146224_r);
+        IMEWrapper.textField.moveCaretPosition(this.field_146224_r);
     }
 
     public void func_146196_d()
@@ -312,123 +314,82 @@
         }
         else
         {
-            switch (p_146201_2_)
-            {
-                case 14:
-
-                    if (GuiScreen.func_146271_m())
-                    {
-                        if (this.field_146226_p)
-                        {
+            switch (p_146201_2_) {
+                case 14 -> {
+                    if (GuiScreen.func_146271_m()) {
+                        if (this.field_146226_p) {
                             this.func_146177_a(-1);
                         }
-                    }
-                    else if (this.field_146226_p)
-                    {
+                    } else if (this.field_146226_p) {
                         this.func_146175_b(-1);
                     }
-
                     return true;
-                case 199:
-
-                    if (GuiScreen.func_146272_n())
-                    {
+                }
+                case 199 -> {
+                    if (GuiScreen.func_146272_n()) {
                         this.func_146199_i(0);
-                    }
-                    else
-                    {
+                    } else {
                         this.func_146196_d();
                     }
-
                     return true;
-                case 203:
-
-                    if (GuiScreen.func_146272_n())
-                    {
-                        if (GuiScreen.func_146271_m())
-                        {
+                }
+                case 203 -> {
+                    if (GuiScreen.func_146272_n()) {
+                        if (GuiScreen.func_146271_m()) {
                             this.func_146199_i(this.func_146183_a(-1, this.func_146186_n()));
-                        }
-                        else
-                        {
+                        } else {
                             this.func_146199_i(this.func_146186_n() - 1);
                         }
-                    }
-                    else if (GuiScreen.func_146271_m())
-                    {
+                    } else if (GuiScreen.func_146271_m()) {
                         this.func_146190_e(this.func_146187_c(-1));
-                    }
-                    else
-                    {
+                    } else {
                         this.func_146182_d(-1);
                     }
-
                     return true;
-                case 205:
-
-                    if (GuiScreen.func_146272_n())
-                    {
-                        if (GuiScreen.func_146271_m())
-                        {
+                }
+                case 205 -> {
+                    if (GuiScreen.func_146272_n()) {
+                        if (GuiScreen.func_146271_m()) {
                             this.func_146199_i(this.func_146183_a(1, this.func_146186_n()));
-                        }
-                        else
-                        {
+                        } else {
                             this.func_146199_i(this.func_146186_n() + 1);
                         }
-                    }
-                    else if (GuiScreen.func_146271_m())
-                    {
+                    } else if (GuiScreen.func_146271_m()) {
                         this.func_146190_e(this.func_146187_c(1));
-                    }
-                    else
-                    {
+                    } else {
                         this.func_146182_d(1);
                     }
-
                     return true;
-                case 207:
-
-                    if (GuiScreen.func_146272_n())
-                    {
+                }
+                case 207 -> {
+                    if (GuiScreen.func_146272_n()) {
                         this.func_146199_i(this.field_146216_j.length());
-                    }
-                    else
-                    {
+                    } else {
                         this.func_146202_e();
                     }
-
                     return true;
-                case 211:
-
-                    if (GuiScreen.func_146271_m())
-                    {
-                        if (this.field_146226_p)
-                        {
+                }
+                case 211 -> {
+                    if (GuiScreen.func_146271_m()) {
+                        if (this.field_146226_p) {
                             this.func_146177_a(1);
                         }
-                    }
-                    else if (this.field_146226_p)
-                    {
+                    } else if (this.field_146226_p) {
                         this.func_146175_b(1);
                     }
-
                     return true;
-                default:
-
-                    if (ChatAllowedCharacters.func_71566_a(p_146201_1_))
-                    {
-                        if (this.field_146226_p)
-                        {
+                }
+                default -> {
+                    if (ChatAllowedCharacters.func_71566_a(p_146201_1_)) {
+                        if (this.field_146226_p) {
                             this.func_146191_b(Character.toString(p_146201_1_));
                         }
 
                         return true;
-                    }
-                    else
-                    {
+                    } else {
                         return false;
                     }
+                }
             }
         }
     }
@@ -579,6 +540,7 @@
         if (this.field_146216_j.length() > p_146203_1_)
         {
             this.field_146216_j = this.field_146216_j.substring(0, p_146203_1_);
+            IMEWrapper.setText(this.field_146216_j);
         }
     }
 
@@ -625,6 +587,12 @@
         {
             Minecraft.func_71410_x().field_71462_r.func_193975_a(p_146195_1_);
         }
+        IMEWrapper.setTextField(this);
+        if (p_146195_1_ && !IMEWrapper.instance.isVisible()) {
+            IMEWrapper.instance.setVisible(true);
+        } else if(!p_146195_1_ && IMEWrapper.instance.isVisible()) {
+            IMEWrapper.instance.setVisible(false);
+        }
     }
 
     public boolean func_146206_l()
@@ -662,34 +630,30 @@
         }
 
         this.field_146223_s = p_146199_1_;
-
-        if (this.field_146211_a != null)
-        {
-            if (this.field_146225_q > i)
-            {
-                this.field_146225_q = i;
-            }
-
-            int j = this.func_146200_o();
-            String s = this.field_146211_a.func_78269_a(this.field_146216_j.substring(this.field_146225_q), j);
-            int k = s.length() + this.field_146225_q;
-
-            if (p_146199_1_ == this.field_146225_q)
-            {
-                this.field_146225_q -= this.field_146211_a.func_78262_a(this.field_146216_j, j, true).length();
-            }
-
-            if (p_146199_1_ > k)
-            {
-                this.field_146225_q += p_146199_1_ - k;
-            }
-            else if (p_146199_1_ <= this.field_146225_q)
-            {
-                this.field_146225_q -= this.field_146225_q - p_146199_1_;
-            }
-
-            this.field_146225_q = MathHelper.func_76125_a(this.field_146225_q, 0, i);
-        }
+        IMEWrapper.textField.select(0, p_146199_1_);
+        if (this.field_146225_q > i) {
+            this.field_146225_q = i;
+        }
+
+        int j = this.func_146200_o();
+        String s = this.field_146211_a.func_78269_a(this.field_146216_j.substring(this.field_146225_q), j);
+        int k = s.length() + this.field_146225_q;
+
+        if (p_146199_1_ == this.field_146225_q)
+        {
+            this.field_146225_q -= this.field_146211_a.func_78262_a(this.field_146216_j, j, true).length();
+        }
+
+        if (p_146199_1_ > k)
+        {
+            this.field_146225_q += p_146199_1_ - k;
+        }
+        else if (p_146199_1_ <= this.field_146225_q)
+        {
+            this.field_146225_q -= this.field_146225_q - p_146199_1_;
+        }
+
+        this.field_146225_q = MathHelper.func_76125_a(this.field_146225_q, 0, i);
     }
 
     public void func_146205_d(boolean p_146205_1_)
