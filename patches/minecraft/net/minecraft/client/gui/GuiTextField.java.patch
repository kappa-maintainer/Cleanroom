--- before/net/minecraft/client/gui/GuiTextField.java
+++ after/net/minecraft/client/gui/GuiTextField.java
@@ -1,7 +1,7 @@
 package net.minecraft.client.gui;
 
+import com.cleanroommc.client.ime.IMEWrapper;
 import com.google.common.base.Predicate;
-import com.google.common.base.Predicates;
 import net.minecraft.client.Minecraft;
 import net.minecraft.client.renderer.BufferBuilder;
 import net.minecraft.client.renderer.GlStateManager;
@@ -11,6 +11,9 @@
 import net.minecraft.util.math.MathHelper;
 import net.minecraftforge.fml.relauncher.Side;
 import net.minecraftforge.fml.relauncher.SideOnly;
+import org.lwjglx.opengl.Display;
+
+import javax.swing.*;
 
 @SideOnly(Side.CLIENT)
 public class GuiTextField extends Gui
@@ -21,6 +24,8 @@
     public int field_146210_g;
     public int field_146218_h;
     public int field_146219_i;
+    private int imeX = 0;
+    private int imeY = 0;
     private String field_146216_j = "";
     private int field_146217_k = 32;
     private int field_146214_l;
@@ -35,7 +40,7 @@
     private int field_146221_u = 7368816;
     private boolean field_146220_v = true;
     private GuiPageButtonList.GuiResponder field_175210_x;
-    private Predicate<String> field_175209_y = Predicates.<String>alwaysTrue();
+    private java.util.function.Predicate<String> field_175209_y = s -> true;
 
     public GuiTextField(int p_i45542_1_, FontRenderer p_i45542_2_, int p_i45542_3_, int p_i45542_4_, int p_i45542_5_, int p_i45542_6_)
     {
@@ -59,7 +64,7 @@
 
     public void func_146180_a(String p_146180_1_)
     {
-        if (this.field_175209_y.apply(p_146180_1_))
+        if (this.field_175209_y.test(p_146180_1_))
         {
             if (p_146180_1_.length() > this.field_146217_k)
             {
@@ -69,11 +74,26 @@
             {
                 this.field_146216_j = p_146180_1_;
             }
-
-            this.func_146202_e();
-        }
-    }
-
+            IMEWrapper.setText(this.field_146216_j);
+            this.func_146202_e();
+        }
+    }
+
+    public void setTextNoSync(String textIn)
+    {
+        if (this.field_175209_y.test(textIn))
+        {
+            if (textIn.length() > this.field_146217_k)
+            {
+                this.field_146216_j = textIn.substring(0, this.field_146217_k);
+            }
+            else
+            {
+                this.field_146216_j = textIn;
+            }
+            this.func_146202_e();
+        }
+    }
     public String func_146179_b()
     {
         return this.field_146216_j;
@@ -81,22 +101,22 @@
 
     public String func_146207_c()
     {
-        int i = this.field_146224_r < this.field_146223_s ? this.field_146224_r : this.field_146223_s;
-        int j = this.field_146224_r < this.field_146223_s ? this.field_146223_s : this.field_146224_r;
+        int i = Math.min(this.field_146224_r, this.field_146223_s);
+        int j = Math.max(this.field_146224_r, this.field_146223_s);
         return this.field_146216_j.substring(i, j);
     }
 
     public void func_175205_a(Predicate<String> p_175205_1_)
     {
-        this.field_175209_y = p_175205_1_;
+        this.field_175209_y = p_175205_1_::test;
     }
 
     public void func_146191_b(String p_146191_1_)
     {
         String s = "";
         String s1 = ChatAllowedCharacters.func_71565_a(p_146191_1_);
-        int i = this.field_146224_r < this.field_146223_s ? this.field_146224_r : this.field_146223_s;
-        int j = this.field_146224_r < this.field_146223_s ? this.field_146223_s : this.field_146224_r;
+        int i = Math.min(this.field_146224_r, this.field_146223_s);
+        int j = Math.max(this.field_146224_r, this.field_146223_s);
         int k = this.field_146217_k - this.field_146216_j.length() - (i - j);
 
         if (!this.field_146216_j.isEmpty())
@@ -122,9 +142,10 @@
             s = s + this.field_146216_j.substring(j);
         }
 
-        if (this.field_175209_y.apply(s))
+        if (this.field_175209_y.test(s))
         {
             this.field_146216_j = s;
+            IMEWrapper.setText(s);
             this.func_146182_d(i - this.field_146223_s + l);
             this.func_190516_a(this.field_175208_g, this.field_146216_j);
         }
@@ -178,10 +199,10 @@
                     s = s + this.field_146216_j.substring(j);
                 }
 
-                if (this.field_175209_y.apply(s))
+                if (this.field_175209_y.test(s))
                 {
                     this.field_146216_j = s;
-
+                    IMEWrapper.setText(s);
                     if (flag)
                     {
                         this.func_146182_d(p_146175_1_);
@@ -254,7 +275,6 @@
     {
         this.func_146190_e(this.field_146223_s + p_146182_1_);
     }
-
     public void func_146190_e(int p_146190_1_)
     {
         this.field_146224_r = p_146190_1_;
@@ -262,7 +282,25 @@
         this.field_146224_r = MathHelper.func_76125_a(this.field_146224_r, 0, i);
         this.func_146199_i(this.field_146224_r);
     }
+    public void setCursorPositionNoSync(int pos)
+    {
+        this.field_146224_r = pos;
+    }
 
+    private void updateWrapperLocation() {
+        SwingUtilities.invokeLater(
+                () -> {
+                    IMEWrapper.textField.moveCaretPosition(this.field_146224_r);
+                    GuiScreen s = Minecraft.func_71410_x().field_71462_r;
+                    if(imeY == 0 || s == null) {
+                        IMEWrapper.instance.setLocation(Display.getX(), Display.getY() + Display.getHeight());
+                        return;
+                    }
+                    int f = IMEWrapper.scaledResolution.func_78325_e();
+                    IMEWrapper.instance.setLocation(Display.getX() + imeX * f, Display.getY() + imeY * f);
+                }
+        );
+    }
     public void func_146196_d()
     {
         this.func_146190_e(0);
@@ -312,123 +350,82 @@
         }
         else
         {
-            switch (p_146201_2_)
-            {
-                case 14:
-
-                    if (GuiScreen.func_146271_m())
-                    {
-                        if (this.field_146226_p)
-                        {
+            switch (p_146201_2_) {
+                case 14 -> {
+                    if (GuiScreen.func_146271_m()) {
+                        if (this.field_146226_p) {
                             this.func_146177_a(-1);
                         }
-                    }
-                    else if (this.field_146226_p)
-                    {
+                    } else if (this.field_146226_p) {
                         this.func_146175_b(-1);
                     }
-
                     return true;
-                case 199:
-
-                    if (GuiScreen.func_146272_n())
-                    {
+                }
+                case 199 -> {
+                    if (GuiScreen.func_146272_n()) {
                         this.func_146199_i(0);
-                    }
-                    else
-                    {
+                    } else {
                         this.func_146196_d();
                     }
-
                     return true;
-                case 203:
-
-                    if (GuiScreen.func_146272_n())
-                    {
-                        if (GuiScreen.func_146271_m())
-                        {
+                }
+                case 203 -> {
+                    if (GuiScreen.func_146272_n()) {
+                        if (GuiScreen.func_146271_m()) {
                             this.func_146199_i(this.func_146183_a(-1, this.func_146186_n()));
-                        }
-                        else
-                        {
+                        } else {
                             this.func_146199_i(this.func_146186_n() - 1);
                         }
-                    }
-                    else if (GuiScreen.func_146271_m())
-                    {
+                    } else if (GuiScreen.func_146271_m()) {
                         this.func_146190_e(this.func_146187_c(-1));
-                    }
-                    else
-                    {
+                    } else {
                         this.func_146182_d(-1);
                     }
-
                     return true;
-                case 205:
-
-                    if (GuiScreen.func_146272_n())
-                    {
-                        if (GuiScreen.func_146271_m())
-                        {
+                }
+                case 205 -> {
+                    if (GuiScreen.func_146272_n()) {
+                        if (GuiScreen.func_146271_m()) {
                             this.func_146199_i(this.func_146183_a(1, this.func_146186_n()));
-                        }
-                        else
-                        {
+                        } else {
                             this.func_146199_i(this.func_146186_n() + 1);
                         }
-                    }
-                    else if (GuiScreen.func_146271_m())
-                    {
+                    } else if (GuiScreen.func_146271_m()) {
                         this.func_146190_e(this.func_146187_c(1));
-                    }
-                    else
-                    {
+                    } else {
                         this.func_146182_d(1);
                     }
-
                     return true;
-                case 207:
-
-                    if (GuiScreen.func_146272_n())
-                    {
+                }
+                case 207 -> {
+                    if (GuiScreen.func_146272_n()) {
                         this.func_146199_i(this.field_146216_j.length());
-                    }
-                    else
-                    {
+                    } else {
                         this.func_146202_e();
                     }
-
                     return true;
-                case 211:
-
-                    if (GuiScreen.func_146271_m())
-                    {
-                        if (this.field_146226_p)
-                        {
+                }
+                case 211 -> {
+                    if (GuiScreen.func_146271_m()) {
+                        if (this.field_146226_p) {
                             this.func_146177_a(1);
                         }
-                    }
-                    else if (this.field_146226_p)
-                    {
+                    } else if (this.field_146226_p) {
                         this.func_146175_b(1);
                     }
-
                     return true;
-                default:
-
-                    if (ChatAllowedCharacters.func_71566_a(p_146201_1_))
-                    {
-                        if (this.field_146226_p)
-                        {
+                }
+                default -> {
+                    if (ChatAllowedCharacters.func_71566_a(p_146201_1_)) {
+                        if (this.field_146226_p) {
                             this.func_146191_b(Character.toString(p_146201_1_));
                         }
 
                         return true;
-                    }
-                    else
-                    {
+                    } else {
                         return false;
                     }
+                }
             }
         }
     }
@@ -521,7 +518,11 @@
                     this.field_146211_a.func_175063_a("_", (float)k1, (float)i1, i);
                 }
             }
-
+            if(imeX != k1 + 1 || imeY != i1 + this.field_146211_a.field_78288_b - 2) {
+                imeX = k1 +1;
+                imeY = i1 + this.field_146211_a.field_78288_b - 2;
+                updateWrapperLocation();
+            }
             if (k != j)
             {
                 int l1 = l + this.field_146211_a.func_78256_a(s.substring(0, k));
@@ -579,6 +580,7 @@
         if (this.field_146216_j.length() > p_146203_1_)
         {
             this.field_146216_j = this.field_146216_j.substring(0, p_146203_1_);
+            IMEWrapper.setText(this.field_146216_j);
         }
     }
 
@@ -625,6 +627,12 @@
         {
             Minecraft.func_71410_x().field_71462_r.func_193975_a(p_146195_1_);
         }
+        IMEWrapper.setTextField(this);
+        if (p_146195_1_ && !IMEWrapper.instance.isVisible()) {
+            IMEWrapper.instance.setVisible(true);
+        } else if(!p_146195_1_ && IMEWrapper.instance.isVisible()) {
+            IMEWrapper.instance.setVisible(false);
+        }
     }
 
     public boolean func_146206_l()
@@ -662,36 +670,34 @@
         }
 
         this.field_146223_s = p_146199_1_;
-
-        if (this.field_146211_a != null)
-        {
-            if (this.field_146225_q > i)
-            {
-                this.field_146225_q = i;
-            }
-
-            int j = this.func_146200_o();
-            String s = this.field_146211_a.func_78269_a(this.field_146216_j.substring(this.field_146225_q), j);
-            int k = s.length() + this.field_146225_q;
-
-            if (p_146199_1_ == this.field_146225_q)
-            {
-                this.field_146225_q -= this.field_146211_a.func_78262_a(this.field_146216_j, j, true).length();
-            }
-
-            if (p_146199_1_ > k)
-            {
-                this.field_146225_q += p_146199_1_ - k;
-            }
-            else if (p_146199_1_ <= this.field_146225_q)
-            {
-                this.field_146225_q -= this.field_146225_q - p_146199_1_;
-            }
-
-            this.field_146225_q = MathHelper.func_76125_a(this.field_146225_q, 0, i);
-        }
-    }
-
+        if (this.field_146225_q > i) {
+            this.field_146225_q = i;
+        }
+
+        int j = this.func_146200_o();
+        String s = this.field_146211_a.func_78269_a(this.field_146216_j.substring(this.field_146225_q), j);
+        int k = s.length() + this.field_146225_q;
+
+        if (p_146199_1_ == this.field_146225_q)
+        {
+            this.field_146225_q -= this.field_146211_a.func_78262_a(this.field_146216_j, j, true).length();
+        }
+
+        if (p_146199_1_ > k)
+        {
+            this.field_146225_q += p_146199_1_ - k;
+        }
+        else if (p_146199_1_ <= this.field_146225_q)
+        {
+            this.field_146225_q -= this.field_146225_q - p_146199_1_;
+        }
+
+        this.field_146225_q = MathHelper.func_76125_a(this.field_146225_q, 0, i);
+    }
+    public void setSelection(int cursor, int end) {
+        setCursorPositionNoSync(cursor);
+        func_146199_i(end);
+    }
     public void func_146205_d(boolean p_146205_1_)
     {
         this.field_146212_n = p_146205_1_;
